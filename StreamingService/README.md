# Streaming Service

StreamingService manages playback control plane APIs, orchestrates OvenMediaEngine (OME) provisioning, and emits downstream notifications once assets are ready for viewing.

## What's Included

- Fastify app (Phase 2 target) with service-to-service auth protecting `/internal` routes.
- Pub/Sub worker (`handleUploadEvent`) that provisions OME channels and triggers cache warmups.
- Firestore/Postgres metadata repository for idempotent provisioning and reconciliation.
- Infrastructure artefacts for OME on GKE Autopilot plus Phase 0/1 documentation.

## Local Development

```bash
npm install
npm run dev # fastify server on :4900
```

Worker entrypoint exports `handleUploadEvent`; refer to [docs/phase-1/worker.md](docs/phase-1/worker.md) for local invocation tips.

## Configuration

Environment variables are documented in [`src/config/index.ts`](src/config/index.ts). Key knobs:

- `OME_*` – API endpoint, credentials, presets, node pools.
- `CHANNEL_REPOSITORY_BACKEND` – `memory`, `firestore`, or `postgres`.
- `CONTENT_SERVICE_CALLBACK_URL`, `API_GATEWAY_CACHE_WARMUP_URL`, `OBSERVABILITY_EXPORT_URL` – downstream webhooks.

## Environment Setup

Copy `.env.example` to `.env` when bootstrapping a new environment. Populate the sensitive values from the following sources:

| Variable | Purpose | Where to obtain |
| --- | --- | --- |
| `SERVICE_AUTH_TOKEN` | Validates calls from API Gateway and Upload Service workers. | Secret Manager secret `platform/service-token` managed by the Auth team. |
| `CDN_SIGNING_SECRET` / `CDN_SIGNING_KEY_ID` | HMAC material for manifest URLs and cache keys. | Provided by the Edge/CDN team; stored in Secret Manager `cdn/streaming-signing`. |
| `CDN_CONTROL_API_KEY` | Authenticates purge/warmup/failover requests. | Issued by the CDN control plane (`cdn-control` Cloud Run service). |
| `OME_API_KEY` / `OME_API_SECRET` | OvenMediaEngine API credentials for provisioning channels. | Created via the OME admin console and vaulted under `ome/admin-api`. |
| `GCS_MANIFEST_BUCKET` | Bucket where HLS manifests + segments are published. | Terraform output `streaming_manifest_bucket`. |
| `CHANNEL_REPOSITORY_BACKEND`, `FIRESTORE_PROJECT_ID`, `POSTGRES_DSN` | Selects metadata backend (Firestore vs. Postgres). | Use Firestore project ID or Cloud SQL DSN from infra outputs. |
| `PUBSUB_UPLOAD_SUBSCRIPTION` | Subscription the worker drains for UploadService events. | `gcloud pubsub subscriptions describe media-uploaded-<env>` -> copy full resource path. |
| `AUTH_SERVICE_INTERNAL_TOKEN` | AuthService service account token for introspection calls. | Rotate via AuthService admin CLI; store in Secret Manager `auth/internal-token`. |
| `BIGQUERY_EXPORT_URL` | HTTPS endpoint that writes analytics envelopes into BigQuery. | Cloud Run URL for the analytics ingestion service. |
| `METRICS_ACCESS_TOKEN` | Shared bearer token required to scrape `/metrics`. | Generated by Observability; stored alongside the OTLP collector secrets. |

## Documentation

- [Phase 0 blueprint](docs/phase-0/README.md)
- [Phase 1 OME integration + worker runbooks](docs/phase-1/README.md)
- [OME Kubernetes manifests](infra/ome/README.md)

## GCP Integration

1. **Pub/Sub ingestion** – Create the `media.uploaded` topic and subscription referenced by `PUBSUB_UPLOAD_SUBSCRIPTION`. Grant the Streaming Service service account the `roles/pubsub.subscriber` role so `UploadEventWorker` can ack/nack messages.
2. **Cloud Monitoring** – Deploy the Fastify service behind an Internal HTTPS Load Balancer and scrape `/metrics` with Cloud Monitoring agents. The new monitoring service polls OvenMediaEngine for realtime stats and exposes them as Prometheus gauges.
3. **BigQuery logging** – Point `BIGQUERY_EXPORT_URL` to a Cloud Run service that writes incoming analytics envelopes to BigQuery. Alerts, CDN events, probe results, and provisioning notifications are streamed through this endpoint.
4. **Cloud CDN + Traffic Director** – Host manifests in regional GCS buckets, front them with Cloud CDN, and configure the CDN control API (referenced by `CDN_CONTROL_BASE_URL`) to manage cache purges, warmups, and failover orchestration. Traffic Director validation runs automatically whenever `/metrics` is scraped.

## OvenMediaEngine Integration

1. **Bootstrap cluster** – Apply the manifests in `infra/ome` to a GKE Autopilot cluster. Provide OME credentials to Secret Manager and surface them via `OME_API_KEY` and `OME_API_SECRET`.
2. **ABR presets** – Tune `OME_REELS_PRESET` and `OME_SERIES_PRESET` to match your ladder. The `ChannelProvisioner` parses these strings and sends them to the OME API when creating channels.
3. **Dry-run + validation** – Set `DRY_RUN_PROVISIONING=true` in lower environments to exercise the pipeline without touching production OME clusters. The OvenMediaEngine client synthesizes responses so downstream cache-warmup and notifications still run.
4. **Failover + probes** – Configure `CDN_FAILOVER_BASE_URL` and `CDN_PROBE_REGIONS`. Synthetic probes call both primary and failover manifests; if 50% or more regions fail, the CDN control plane is asked to promote the failover origin automatically.

## Runbooks

- **Stream registration** – Verify UploadService emitted a `media.uploaded` event, then run `npm run worker:replay -- --contentId <id>` (or trigger the reconciliation worker) to rehydrate metadata. Monitor `streaming_provisioning_total` for failures.
- **Key rotation** – Call `/v1/admin/streams/{contentId}/rotate-ingest` via API Gateway. The route triggers OME ingest rotation and CDN cache purge; confirm success in BigQuery by filtering on the `cdn.failover` event type.
- **Cache warmup** – Use `/v1/admin/streams/{contentId}/purge` followed by a manual `/internal/probes/manifest` request to repopulate CDN edges across critical regions.

## Troubleshooting

- **Manifest latency spikes** – Inspect `/metrics` for `streaming_manifest_latency_ms` buckets and cross-reference the `stream.manifest.latency` alert stream exported to BigQuery.
- **Regional outages** – Trigger `/internal/probes/manifest` to force probes. If more than half the probes fail, the service automatically calls the CDN failover API. Validate the shift through the `cdn.multi_cluster` analytics events.
- **OME stats missing** – Ensure the Streaming Service can reach `OME_API_BASE_URL`. The monitoring service logs failures at `warn` level and continues serving cached metrics, so check application logs for `Failed to collect OME stats`.

## Scripts

- `npm run build` – type-check + emit `dist`.
- `npm run typecheck` – strict TypeScript.
- `npm run lint` – ESLint (imports, best practices).
