generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PublicationStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum Visibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum MediaAssetStatus {
  PENDING
  UPLOADED  // File uploaded but processing not started
  PROCESSING
  READY
  FAILED
}

enum MediaAssetType {
  EPISODE
  REEL
}

model Category {
  id               String   @id @default(uuid())
  slug             String   @unique
  name             String
  description      String?
  displayOrder     Int?
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?

  series Series[]
  reels  Reel[]
}

model Series {
  id               String            @id @default(uuid())
  slug             String            @unique
  title            String
  synopsis         String?
  displayOrder     Int?              // Global or Category-based display order
  heroImageUrl     String?
  bannerImageUrl   String?
  tags             String[]          @default([])
  isAudioSeries    Boolean           @default(false)
  status           PublicationStatus @default(DRAFT)
  visibility       Visibility        @default(PUBLIC)
  releaseDate      DateTime?
  ownerId          String
  categoryId       String?
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  category Category? @relation(fields: [categoryId], references: [id])
  seasons  Season[]
  episodes Episode[]
  reels    Reel[]
  carouselEntries CarouselEntry[]
  mediaAssets MediaAsset[]
  imageAssets ImageAsset[]
  topTenEntry TopTenSeries?

  @@index([categoryId])
  @@index([status, visibility])
}

model Season {
  id               String            @id @default(uuid())
  seriesId         String
  sequenceNumber   Int
  title            String
  synopsis         String?
  status           PublicationStatus @default(DRAFT)
  releaseDate      DateTime?
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  series   Series   @relation(fields: [seriesId], references: [id])
  episodes Episode[]

  @@unique([seriesId, sequenceNumber])
  @@index([seriesId])
}

model Episode {
  id                 String            @id @default(uuid())
  slug               String            @unique
  seriesId           String
  seasonId           String?
  title              String
  synopsis           String?
  episodeNumber      Int?              // Order within Season (or Series if sorting standalone)
  durationSeconds    Int
  status             PublicationStatus @default(DRAFT)
  visibility         Visibility        @default(PUBLIC)
  publishedAt        DateTime?
  availabilityStart  DateTime?
  availabilityEnd    DateTime?
  heroImageUrl       String?
  defaultThumbnailUrl String?
  captions           Json?
  tags               String[]          @default([])
  createdByAdminId   String?
  updatedByAdminId   String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?

  series Series @relation(fields: [seriesId], references: [id])
  season Season? @relation(fields: [seasonId], references: [id])

  mediaAsset MediaAsset?
  imageAssets ImageAsset[]
  reels      Reel[]
  carouselEntries CarouselEntry[]

  @@index([seriesId, status])
  @@index([seasonId])
}

model Reel {
  id               String            @id @default(uuid())
  slug             String            @unique
  title            String
  description      String?
  durationSeconds  Int
  status           PublicationStatus @default(DRAFT)
  visibility       Visibility        @default(PUBLIC)
  publishedAt      DateTime?
  availabilityStart DateTime?
  availabilityEnd  DateTime?
  tags             String[]          @default([])
  ownerId          String?
  categoryId       String?
  episodeId        String?
  seriesId         String?
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  category   Category?  @relation(fields: [categoryId], references: [id])
  episode    Episode?   @relation(fields: [episodeId], references: [id])
  series     Series?    @relation(fields: [seriesId], references: [id])
  mediaAsset MediaAsset?
  imageAssets ImageAsset[]

  @@index([categoryId])
  @@index([episodeId])
  @@index([seriesId])
  @@index([status, visibility])
}

model MediaAsset {
  id              String           @id @default(uuid())
  type            MediaAssetType
  uploadId        String?          @unique // Link to UploadService session
  filename        String?          // Original filename
  title           String?          // User-provided title
  sizeBytes       BigInt?          // File size
  sourceUploadId  String?          // Legacy field, use uploadId
  streamingAssetId String?
  manifestUrl     String?
  defaultThumbnailUrl String?
  status          MediaAssetStatus @default(PENDING)
  createdByAdminId String?
  updatedByAdminId String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  episodeId String? @unique
  reelId    String? @unique
  seriesId  String? // Direct series link (for trailers, extras)

  episode Episode? @relation(fields: [episodeId], references: [id])
  reel    Reel?    @relation(fields: [reelId], references: [id])
  series  Series?  @relation(fields: [seriesId], references: [id])

  variants MediaAssetVariant[]

  @@index([status])
  @@index([seriesId])
}

model ImageAsset {
  id          String           @id @default(uuid())
  uploadId    String           @unique
  filename    String?
  title       String?
  sizeBytes   BigInt?
  url         String           // GCS URL
  status      MediaAssetStatus @default(PENDING)
  
  // Optional linking - can be assigned later
  seriesId String?
  episodeId String?
  reelId    String?

  series  Series?  @relation(fields: [seriesId], references: [id])
  episode Episode? @relation(fields: [episodeId], references: [id])
  reel    Reel?    @relation(fields: [reelId], references: [id])
  
  createdByAdminId String?
  updatedByAdminId String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?

  @@index([status])
  @@index([seriesId])
  @@index([episodeId])
  @@index([reelId])
}

model MediaAssetVariant {
  id             String   @id @default(uuid())
  mediaAssetId   String
  label          String
  width          Int?
  height         Int?
  bitrateKbps    Int?
  codec          String?
  frameRate      Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  mediaAsset MediaAsset @relation(fields: [mediaAssetId], references: [id])

  @@unique([mediaAssetId, label])
  @@index([mediaAssetId])
}

model Tag {
  id               String   @id @default(uuid())
  slug             String   @unique
  name             String   @unique
  description      String?
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  deletedAt        DateTime?
}

model CarouselEntry {
  id               String   @id @default(uuid())
  position         Int
  seriesId         String?
  episodeId        String?
  createdByAdminId String?
  updatedByAdminId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  series  Series?  @relation(fields: [seriesId], references: [id])
  episode Episode? @relation(fields: [episodeId], references: [id])

  @@index([position])
}

model TopTenSeries {
  id        String   @id @default(uuid())
  seriesId  String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series Series @relation(fields: [seriesId], references: [id])

  @@unique([seriesId])
  @@unique([position])
}
