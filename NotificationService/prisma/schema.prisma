generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NotificationType {
  EMAIL
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ     // Mostly for IN_APP
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   // Foreign key to User Service (managed logically)
  type      NotificationType
  title     String
  body      String
  data      Json?    // Additional payload for navigation/actions
  status    NotificationStatus @default(PENDING)
  priority  NotificationPriority @default(MEDIUM)
  
  error     String?  // Error message if failed
  
  // FCM-specific fields
  fcmMessageId String? // Firebase Cloud Messaging message ID
  fcmError     String? // FCM delivery error, if any
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // For In-App grouping/threading if needed
  groupId   String?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model UserNotificationPreference {
  userId           String   @id // 1:1, matches User ID
  
  emailEnabled     Boolean  @default(true)
  pushEnabled      Boolean  @default(true)
  inAppEnabled     Boolean  @default(true)
  
  // Granular generic categories
  allowMarketing   Boolean  @default(true)
  allowTransactional Boolean @default(true)
  allowNewContent  Boolean  @default(true)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model NotificationTemplate {
  id          String   @id @default(uuid())
  code        String   @unique // e.g. "WELCOME_EMAIL"
  type        NotificationType
  subject     String?  // For Email
  title       String?  // For Push
  body        String   // Supports template variables {{name}}
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FcmToken {
  id        String   @id @default(uuid())
  userId    String   // Foreign key to User Service
  token     String   @unique // FCM device token
  deviceId  String?  // Optional device identifier
  platform  String?  // "ios", "android", "web"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsed  DateTime @default(now())

  @@index([userId])
  @@index([token])
}

