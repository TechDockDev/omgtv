generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String                @id @default(uuid())
  name        String                @unique
  description String?
  isSystem    Boolean               @default(false)
  permissions RolePermission[]
  assignments UserRoleAssignment[]
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
}

model Permission {
  id          String          @id @default(uuid())
  resource    String
  action      String
  description String?
  roles       RolePermission[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([resource, action])
}

model RolePermission {
  id           String      @id @default(uuid())
  role         Role        @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permission  @relation(fields: [permissionId], references: [id])
  permissionId String
  createdAt    DateTime    @default(now())
  createdBy    String?

  @@unique([roleId, permissionId])
}

model UserRoleAssignment {
  id         String   @id @default(uuid())
  userId     String
  role       Role     @relation(fields: [roleId], references: [id])
  roleId     String
  scope      String?
  grantedBy  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  revokedAt  DateTime?
  isActive   Boolean  @default(true)

  @@index([userId])
  @@unique([userId, roleId, scope])
}

enum GuestStatus {
  ACTIVE
  MIGRATED
}

model DeviceIdentity {
  id           String               @id @default(uuid())
  deviceId     String               @unique
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  lastSeenAt   DateTime?
  customerLinks CustomerDeviceLink[]
  guestProfiles GuestProfile[]
}

model CustomerProfile {
  id           String               @id @default(uuid())
  firebaseUid  String               @unique
  phoneNumber  String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  devices      CustomerDeviceLink[]
  guestMigrations GuestProfile[]    @relation("GuestCustomerMigration")
}

model CustomerDeviceLink {
  id               String          @id @default(uuid())
  customer         CustomerProfile @relation(fields: [customerId], references: [id])
  customerId       String
  device           DeviceIdentity  @relation(fields: [deviceIdentityId], references: [id])
  deviceIdentityId String
  firstLinkedAt    DateTime        @default(now())
  lastLinkedAt     DateTime        @updatedAt

  @@unique([customerId, deviceIdentityId])
}

model GuestProfile {
  id               String           @id @default(uuid())
  guestId          String
  device           DeviceIdentity   @relation(fields: [deviceIdentityId], references: [id])
  deviceIdentityId String
  status           GuestStatus      @default(ACTIVE)
  migratedAt       DateTime?
  customer         CustomerProfile? @relation("GuestCustomerMigration", fields: [customerId], references: [id])
  customerId       String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([guestId, deviceIdentityId])
}
